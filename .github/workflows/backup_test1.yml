name: Test Backup Script

on: 
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  test-script:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Install PostgreSQL
      run: sudo apt-get update && sudo apt-get install -y postgresql

    - name: Start PostgreSQL service
      run: sudo service postgresql start

    - name: Create PostgreSQL user and database
      run: |
        sudo -u postgres psql -c "CREATE USER postgres1 WITH SUPERUSER;"
        sudo -u postgres psql -c "CREATE DATABASE omero_database;"

    - name: Create backup directory
      run: sudo mkdir -p /OMERO/backup/database

    - name: Set permissions for backup directory
      run: sudo chown -R postgres /OMERO/backup/database

    - name: Run the backup script
      run: |
        cd /tmp
        #!/bin/bash
        DATE=`date '+%Y-%m-%d_%H:%M:%S-%Z'`
        OUTPUT_DIRECTORY=/tmp/OMERO/backup/database
        DATABASE="omero_database"
        DATABASE_ADMIN="postgres1"
        
        # Create the backup directory if it doesn't exist
        mkdir -p $OUTPUT_DIRECTORY
        
        # Set the appropriate permissions
        chown -R $DATABASE_ADMIN $OUTPUT_DIRECTORY
        
        # Perform the database backup using pg_dump
        su $DATABASE_ADMIN -c "pg_dump -Fc -f $OUTPUT_DIRECTORY/$DATABASE.$DATE.pg_dump $DATABASE"

    - name: Verify backup
      run: ls /OMERO/backup/database/*.pg_dump
